String cron_string = "0 0 */20 * *" // cron every 20th of the month
def status = ''

def createStage(stageName, jobName) {

  script {
      try {

        stage("${stageName}") {

          build job: "${jobName}"

        }
        // slackSend(channel: "#channelName", message: "Message")
      } catch (Exception e) {

        println(e.getMessage());
        // slackSend(channel: "#channelName", message: "Message")


        throw e;

      }

  }

}

pipeline {
  agent none
  triggers {
    cron(cron_string)
  }
  parameters {

    string(name: 'JIRA_TICKET_NUMBER', description: 'Jira Ticket Number',defaultValue:currentBuild.previousBuild.buildVariables["ticketNumber"]?:'')
    string(name: 'FIELD_PATH', description: 'Field on the Jira Issue to Watch',defaultValue:'status.name')
    string(name: 'FIELD_TARGET_VALUE', description: 'Field target value when trigger the job',defaultValue:'Scheduled')
  }

  stages {
    stage('check the jira field status') {
      agent any
      steps {
       withCredentials([[
            $class: 'UsernamePasswordMultiBinding',
            credentialsId: "jira-creds",
            usernameVariable: 'JIRA_USERNAME',
            passwordVariable: 'JIRA_API_TOKEN',
        ]]) {
            
          script {
     
            if(params.JIRA_TICKET_NUMBER != null){

              status = sh(returnStdout: true, script: "python3 scripts/check_status_field.py ${params.JIRA_TICKET_NUMBER}")
              status = status.replaceAll("[\n\r]", "");
              println(status);
            }
          
          }
        }
      }
    }
  // create the jobs dynamically
  stage('build the UAT and prod jobs') {

    steps {

      script {

          // if the status value is equal to the target value then only build
          if(status.equals(params.FIELD_TARGET_VALUE) ){
              def previousBuildTicket = currentBuild.previousBuild.buildVariables["ticketNumber"];
              if(params.JIRA_TICKET_NUMBER != previousBuildTicket){

                  echo "hello building...."

              }
          
          }
        }
      }
    }
  }
   
  post {
    always {
      echo "====++++always++++===="
    }
    success {
      echo "====++++only when successful ++++===="
    }
    failure {
      echo "====++++only when failed++++===="
    }
  }
}
